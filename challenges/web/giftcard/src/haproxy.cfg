global
    lua-load delay.lua
    # Assumes haproxy.pem is in /etc/haproxy/certs/
    crt-base .

defaults
    mode http
    timeout connect 10s
    timeout client 30s
    timeout server 30s

# ---------------------------------------------------------------------
# Frontend for HTTP traffic, forwarded from sslh.
# Listens ONLY on localhost.
# ---------------------------------------------------------------------
frontend fe_http
    bind 127.0.0.1:8081
    mode http

    # Use 'path' for older HAProxy versions
    acl is_healthz path /healthz

    # This frontend's ONLY job is to handle HTTP requests.
    # 1. If it's /healthz, return 200 OK.
    http-request return status 200 if is_healthz
    # 2. For ALL other requests, return the 403 error.
    http-request return status 403 content-type "text/plain" lf-string "Please access on https!"

# ---------------------------------------------------------------------
# Frontend for HTTPS traffic, forwarded from sslh.
# Listens ONLY on localhost.
# ---------------------------------------------------------------------
frontend fe_https
    # This is where SSL is terminated.
    bind 127.0.0.1:8443 ssl crt haproxy.pem
    mode http

    # Apply the Lua delay to all incoming HTTPS requests.
    http-request lua.delay_request
    
    # Send traffic to the backend.
    default_backend be

# ---------------------------------------------------------------------
# The actual backend application server.
# ---------------------------------------------------------------------
backend be
    # Connect to the backend using SSL but DO NOT verify its certificate.
    server s1 127.0.0.1:8080 ssl verify none
